#!/bin/bash

# Function to check if git repository exists
check_git_repo() {
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        echo "‚ùå Error: Not a git repository"
        exit 1
    fi
    echo "‚úÖ Valid git repository detected"
}

# Function to check if there are any changes
check_changes() {
    if [ -z "$(git status --porcelain)" ]; then
        echo "‚ÑπÔ∏è No changes to commit"
        exit 0
    fi
    echo "‚úÖ Changes detected"
}

# Function to generate commit message
generate_commit_message() {
    local diff_content=$(git diff --cached)
    local files_changed=$(git status --porcelain)

    echo "ü§î Analyzing changes and generating commit message..."

    local commit_message=$(echo -e "Files changed:\n$files_changed\n\nChanges:\n$diff_content" | \
        llm -m anthropic/claude-3-5-sonnet-latest \
        "Generate a git commit message for these changes. The message must have:

        1. TITLE LINE: A specific, concise summary (max 50 chars) that clearly
           describes the primary change or feature. This should not be generic like
           'Update files' but rather describe the actual change like 'Add user
           authentication to API endpoints'

        2. BLANK LINE

        3. DETAILED DESCRIPTION: A thorough explanation including:
           - What changes were made
           - Why they were necessary
           - Any important technical details
           - Breaking changes or important notes
           Wrap this at 72 chars.

        IMPORTANT:
        - Output ONLY the commit message
        - Make sure the title is specific to these changes
        - Focus on the what and why, not just the how")

    echo "‚úÖ Commit message generated"
    echo "üìù Preview of commit message:"
    echo "-------------------"
    echo "$commit_message"
    echo "-------------------"

    echo "$commit_message"
}

# Main execution
main() {
    echo "üîç Starting commit process..."
    check_git_repo
    check_changes

    echo "‚ûï Adding all files to staging..."
    git add --all

    commit_message=$(generate_commit_message)

    echo "üöÄ Committing changes..."
    if ! git commit -m "$commit_message"; then
        echo "‚ùå Commit failed. Please fix any pre-commit hook issues and try again."
        exit 1
    fi

    echo "‚ú® Commit completed successfully!"
}

main "$@"
